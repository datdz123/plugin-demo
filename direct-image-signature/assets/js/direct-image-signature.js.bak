jQuery(document).ready(function($) {
    // Biến toàn cục
    let fabricCanvas;
    let originalImageWidth, originalImageHeight;
    let originalImage = null;
    let originalSrc = '';
    let currentImg = null;
    let fancyboxInstance = null;
    
    // Thêm icon ký cho tất cả hình ảnh
    function addSignatureIconToImages() {
        console.log("Đang thêm icon ký vào hình ảnh...");
        
        // Tìm tất cả các hình ảnh trên trang và thêm icon ký
        $('img').not('.dis-excluded, .dis-signature-icon-img, .dis-result-img').each(function(index) {
            const img = $(this);
            
            // Gán ID cho hình ảnh
            if (!img.attr('data-dis-index')) {
                img.attr('data-dis-index', 'img-dis-' + index);
            }
            
            // Chỉ xử lý nếu chưa có wrapper
            if (!img.parent().hasClass('dis-image-wrapper')) {
                // Tạo wrapper
                img.wrap('<div class="dis-image-wrapper"></div>');
                
                // Tạo icon chữ ký
                const iconHtml = `
                    <div class="dis-signature-icon" data-img-id="${img.attr('data-dis-index')}">
                        <img src="${dis_ajax.plugin_url}assets/images/signature-icon.png" alt="Ký" class="dis-signature-icon-img">
                    </div>
                `;
                
                // Thêm icon vào wrapper
                img.parent().append(iconHtml);
                
                console.log("Đã thêm icon ký cho hình ảnh:", img.attr('src'));
            }
        });
    }
    
    // Thêm icon ký cho tất cả hình ảnh (gọi lại nhiều lần để đảm bảo bắt được tất cả hình ảnh)
    function initSignatureIcons() {
        // Gọi ngay lần đầu
        addSignatureIconToImages();
        
        // Gọi lại sau 1 giây
        setTimeout(function() {
            addSignatureIconToImages();
        }, 1000);
        
        // Gọi lại sau 3 giây
        setTimeout(function() {
            addSignatureIconToImages();
        }, 3000);
    }
    
    // Khởi tạo canvas ký
    function initSignatureCanvas(img) {
        console.log("Khởi tạo canvas ký cho hình ảnh:", img.src);
        
        // Lưu hình ảnh gốc
        currentImg = img;
        originalSrc = img.src;
        
        // Tải hình ảnh và kiểm tra hướng EXIF
        loadImageWithOrientation(originalSrc, function(correctedImg) {
            originalImage = correctedImg;
            originalImageWidth = correctedImg.width;
            originalImageHeight = correctedImg.height;
            
            // Mở Fancybox với hình ảnh đã điều chỉnh hướng
            openImageInFancybox(correctedImg.src);
        });
    }
    
    // Mở hình ảnh trong Fancybox
    function openImageInFancybox(src) {
        Fancybox.show([
            {
                src: src,
                type: 'image'
            }
        ], {
            on: {
                done: (fancybox) => {
                    fancyboxInstance = fancybox;
                    setTimeout(function() {
                        initCanvasOverImage();
                    }, 500);
                },
                close: (fancybox) => {
                    if (fabricCanvas) {
                        fabricCanvas.dispose();
                        fabricCanvas = null;
                    }
                    $('.dis-lightbox-canvas-wrapper').remove();
                    $('#dis-container').hide();
                }
            }
        });
    }
    
    // Khởi tạo canvas phủ lên hình ảnh trong Fancybox
    function initCanvasOverImage() {
        // Hiển thị container công cụ
        $('#dis-container').show();
        
        // Tìm hình ảnh trong Fancybox
        const lightboxImg = $('.fancybox__content img');
        if (!lightboxImg.length) {
            console.error("Không tìm thấy hình ảnh trong Fancybox");
            return;
        }
        
        // Lấy kích thước và vị trí của hình ảnh
        const imgWidth = lightboxImg.width();
        const imgHeight = lightboxImg.height();
        const imgOffset = lightboxImg.offset();
        
        console.log("Kích thước hình ảnh:", imgWidth, "x", imgHeight);
        console.log("Vị trí hình ảnh:", imgOffset.top, imgOffset.left);
        
        // Tạo wrapper cho canvas
        const canvasWrapper = $('<div class="dis-lightbox-canvas-wrapper"></div>');
        canvasWrapper.css({
            position: 'absolute',
            top: imgOffset.top,
            left: imgOffset.left,
            width: imgWidth,
            height: imgHeight,
            zIndex: 9999
        });
        
        // Thêm canvas vào wrapper
        canvasWrapper.append('<canvas id="dis-canvas"></canvas>');
        $('body').append(canvasWrapper);
        
        // Khởi tạo Fabric canvas
        if (fabricCanvas) {
            fabricCanvas.dispose();
        }
        
        fabricCanvas = new fabric.Canvas('dis-canvas');
        fabricCanvas.setWidth(imgWidth);
        fabricCanvas.setHeight(imgHeight);
        
        // Thiết lập chế độ vẽ tự do
        fabricCanvas.isDrawingMode = true;
        fabricCanvas.freeDrawingBrush.width = parseInt($('#dis-size').val());
        fabricCanvas.freeDrawingBrush.color = $('#dis-color').val();
        
        console.log("Đã khởi tạo canvas thành công");
    }
    
    // Xử lý hướng hình ảnh EXIF
    function loadImageWithOrientation(src, callback) {
        const img = new Image();
        
        img.onload = function() {
            // Kiểm tra nếu EXIF.js đã được tải
            if (typeof EXIF === 'undefined') {
                console.warn("EXIF.js chưa được tải, sử dụng hình ảnh gốc");
                callback(img);
                return;
            }
            
            // Tạo canvas tạm thời để xử lý hướng
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Mặc định giữ kích thước gốc
            let width = img.width;
            let height = img.height;
            let orientation;
            
            // Xử lý định hướng EXIF
            EXIF.getData(img, function() {
                orientation = EXIF.getTag(this, 'Orientation');
                console.log("Orientation của hình ảnh:", orientation);
                
                // Đảo kích thước nếu cần
                if (orientation > 4 && orientation < 9) {
                    canvas.width = height;
                    canvas.height = width;
                } else {
                    canvas.width = width;
                    canvas.height = height;
                }
                
                // Xử lý định hướng dựa trên giá trị EXIF
                switch (orientation) {
                    case 2:
                        // horizontal flip
                        ctx.translate(width, 0);
                        ctx.scale(-1, 1);
                        break;
                    case 3:
                        // 180° rotate left
                        ctx.translate(width, height);
                        ctx.rotate(Math.PI);
                        break;
                    case 4:
                        // vertical flip
                        ctx.translate(0, height);
                        ctx.scale(1, -1);
                        break;
                    case 5:
                        // vertical flip + 90 rotate right
                        ctx.rotate(0.5 * Math.PI);
                        ctx.scale(1, -1);
                        break;
                    case 6:
                        // 90° rotate right
                        ctx.rotate(0.5 * Math.PI);
                        ctx.translate(0, -height);
                        break;
                    case 7:
                        // horizontal flip + 90 rotate right
                        ctx.rotate(0.5 * Math.PI);
                        ctx.translate(width, -height);
                        ctx.scale(-1, 1);
                        break;
                    case 8:
                        // 90° rotate left
                        ctx.rotate(-0.5 * Math.PI);
                        ctx.translate(-width, 0);
                        break;
                }
                
                // Vẽ hình ảnh với hướng đã điều chỉnh
                ctx.drawImage(img, 0, 0, width, height);
                
                // Tạo hình ảnh mới với hướng đúng
                const correctedImage = new Image();
                correctedImage.onload = function() {
                    callback(correctedImage);
                };
                correctedImage.src = canvas.toDataURL('image/png');
            });
        };
        
        // Tải ảnh từ dataURL
        img.src = src;
        
        // Xử lý lỗi tải hình ảnh
        img.onerror = function() {
            console.error("Lỗi khi tải hình ảnh:", src);
            // Sử dụng callback với hình ảnh gốc
            callback(img);
        };
    }
    
    // Lưu hình ảnh đã ký
    function saveSignedImage() {
        // Hiển thị loading
        $('.dis-loading').show();
        
        // Lấy dữ liệu hình ảnh từ canvas
        const dataURL = fabricCanvas.toDataURL({
            format: 'png',
            quality: 1,
            width: originalImageWidth,
            height: originalImageHeight
        });
        
        // Gửi dữ liệu hình ảnh lên server
        $.ajax({
            url: dis_ajax.ajax_url,
            type: 'POST',
            data: {
                action: 'dis_save_image',
                nonce: dis_ajax.nonce,
                image_data: dataURL
            },
            success: function(response) {
                $('.dis-loading').hide();
                
                if (response.success) {
                    // Đóng Fancybox
                    if (fancyboxInstance) {
                        fancyboxInstance.close();
                        fancyboxInstance = null;
                    }
                    
                    // Xóa canvas
                    if (fabricCanvas) {
                        fabricCanvas.dispose();
                        fabricCanvas = null;
                    }
                    $('.dis-lightbox-canvas-wrapper').remove();
                    
                    // Hiển thị kết quả
                    showResultDialog(response.data.url);
                } else {
                    alert('Lỗi: ' + response.data);
                }
            },
            error: function() {
                $('.dis-loading').hide();
                alert('Đã xảy ra lỗi khi lưu hình ảnh');
            }
        });
    }
    
    // Hiển thị hộp thoại kết quả
    function showResultDialog(imageUrl) {
        $('#dis-result-img').attr('src', imageUrl);
        $('#dis-result-link').attr('href', imageUrl);
        $('#dis-result-fancy-link').attr('href', imageUrl);
        $('.dis-result-dialog').fadeIn();
    }
    
    // Gắn sự kiện cho các nút trong toolbar
    function bindEvents() {
        // Sự kiện click vào icon ký
        $(document).on('click', '.dis-signature-icon', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log("Đã click vào icon ký");
            
            const imgId = $(this).data('img-id');
            console.log("ID hình ảnh:", imgId);
            
            const img = $('img[data-dis-index="' + imgId + '"]');
            
            if (img.length) {
                console.log("Đã tìm thấy hình ảnh, bắt đầu khởi tạo canvas");
                initSignatureCanvas(img[0]);
            } else {
                console.error("Không tìm thấy hình ảnh với ID:", imgId);
            }
        });
        
        // Gắn sự kiện trực tiếp vào hình ảnh (nếu không có icon)
        $(document).on('click', 'img:not(.dis-excluded, .dis-signature-icon-img, .dis-result-img)', function(e) {
            // Chỉ xử lý nếu không có icon hoặc icon chưa được khởi tạo
            if (!$(this).parent().hasClass('dis-image-wrapper')) {
                console.log("Click trực tiếp vào hình ảnh");
                initSignatureCanvas(this);
            }
        });
        
        // Nút vẽ chữ ký
        $(document).on('click', '#dis-draw', function() {
            if (fabricCanvas) {
                fabricCanvas.isDrawingMode = true;
                $(this).addClass('active');
            }
        });
        
        // Nút xóa chữ ký
        $(document).on('click', '#dis-clear', function() {
            if (fabricCanvas) {
                fabricCanvas.clear();
                
                // Thêm lại ảnh gốc
                const lightboxImg = $('.fancybox__content img');
                const imgWidth = lightboxImg.width();
                const imgHeight = lightboxImg.height();
                
                fabric.Image.fromURL(originalImage.src, function(img) {
                    fabricCanvas.setBackgroundImage(img, fabricCanvas.renderAll.bind(fabricCanvas), {
                        scaleX: imgWidth / originalImageWidth,
                        scaleY: imgHeight / originalImageHeight,
                        originX: 'left',
                        originY: 'top'
                    });
                });
            }
        });
        
        // Điều chỉnh kích thước bút vẽ
        $(document).on('input', '#dis-size', function() {
            if (fabricCanvas) {
                const size = parseInt($(this).val());
                fabricCanvas.freeDrawingBrush.width = size;
            }
        });
        
        // Điều chỉnh màu bút vẽ
        $(document).on('input', '#dis-color', function() {
            if (fabricCanvas) {
                const color = $(this).val();
                fabricCanvas.freeDrawingBrush.color = color;
            }
        });
        
        // Nút lưu hình ảnh
        $(document).on('click', '#dis-save', function() {
            saveSignedImage();
        });
        
        // Nút hủy
        $(document).on('click', '#dis-cancel', function() {
            if (fancyboxInstance) {
                fancyboxInstance.close();
                fancyboxInstance = null;
            }
        });
        
        // Nút đóng kết quả
        $(document).on('click', '#dis-result-close', function() {
            $('.dis-result-dialog').fadeOut();
        });
    }
    
    // Khởi tạo plugin
    function init() {
        console.log("Khởi tạo plugin Direct Image Signature");
        
        // Thêm icon ký cho tất cả hình ảnh
        initSignatureIcons();
        
        // Gắn sự kiện
        bindEvents();
        
        // Kiểm tra và thêm lại icon khi tải thêm nội dung AJAX
        $(document).ajaxComplete(function() {
            console.log("AJAX hoàn tất, kiểm tra lại hình ảnh");
            setTimeout(function() {
                addSignatureIconToImages();
            }, 500);
        });
        
        // Kiểm tra lại sau khi trang đã tải hoàn tất
        $(window).on('load', function() {
            console.log("Trang đã tải hoàn tất, kiểm tra lại hình ảnh");
            setTimeout(function() {
                addSignatureIconToImages();
            }, 1000);
        });
    }
    
    // Chạy khởi tạo
    init();
}); 